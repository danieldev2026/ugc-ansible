# =====================
# Base / shared
# =====================
- name: Ensure /opt/ugc directory exists
  file:
    path: /opt/ugc
    state: directory
    owner: ducle
    group: ducle
    mode: '0755'
  tags: [base]

- name: Ensure base directories
  file:
    path: "/opt/ugc/{{ item }}"
    state: directory
    owner: ducle
    group: ducle
    mode: '0755'
  loop:
    - env
    - volumes
    - nginx
    - nginx/conf.d
  tags: [base]

- name: Copy nginx config
  copy:
    src: nginx/nginx.conf
    dest: /opt/ugc/nginx/nginx.conf
    owner: ducle
    group: ducle
    mode: '0644'
  tags: [base, nginx]

- name: Copy nginx sites config
  copy:
    src: nginx/conf.d/sites.conf
    dest: /opt/ugc/nginx/conf.d/sites.conf
    owner: ducle
    group: ducle
    mode: '0644'
  tags: [base, nginx]

- name: Copy docker-compose.yml
  copy:
    src: docker-compose.yml
    dest: /opt/ugc/docker-compose.yml
    owner: ducle
    group: ducle
    mode: '0644'
  tags: [base, docker]

- name: Copy env files
  copy:
    src: "env/{{ item }}"
    dest: "/opt/ugc/env/{{ item }}"
    owner: ducle
    group: ducle
    mode: '0644'
  loop:
    - api.env
    - admin-api.env
    - admin.env
    - ui.env
  tags: [base, env]

# =====================
# Clone repos
# =====================
- name: Clone ugc-ui
  become: false
  git:
    repo: git@github.com:danieldev2026/ugc-ui.git
    dest: /opt/ugc/ugc-ui
    version: develop
    force: yes
  tags: [ugc-ui]

- name: Clone ugc-api
  become: false
  git:
    repo: git@github.com:danieldev2026/ugc-api.git
    dest: /opt/ugc/ugc-api
    version: develop
    force: yes
  tags: [ugc-api]

- name: Clone ugc-admin-api
  become: false
  git:
    repo: git@github.com:danieldev2026/ugc-admin-api.git
    dest: /opt/ugc/ugc-admin-api
    version: develop
    force: yes
  tags: [ugc-admin-api]

- name: Clone ugc-admin
  become: false
  git:
    repo: git@github.com:danieldev2026/ugc-admin.git
    dest: /opt/ugc/ugc-admin
    version: develop
    force: yes
  tags: [ugc-admin]

# =====================
# Service env
# =====================
- name: Copy api env to ugc-api
  copy:
    src: env/api.env
    dest: /opt/ugc/ugc-api/.env
    owner: ducle
    group: ducle
    mode: '0644'
  tags: [ugc-api, env]

- name: Copy admin api env to ugc-admin-api
  copy:
    src: env/admin-api.env
    dest: /opt/ugc/ugc-admin-api/.env
    owner: ducle
    group: ducle
    mode: '0644'
  tags: [ugc-admin-api, env]

- name: Copy admin env to ugc-admin
  copy:
    src: env/admin.env
    dest: /opt/ugc/ugc-admin/.env
    owner: ducle
    group: ducle
    mode: '0644'
  tags: [ugc-admin, env]

- name: Copy web env to ugc-ui
  copy:
    src: env/ui.env
    dest: /opt/ugc/ugc-ui/.env
    owner: ducle
    group: ducle
    mode: '0644'
  tags: [ugc-ui, env]

# =====================
# Docker
# =====================
- name: Docker compose build and up
  become: true
  command: docker compose up -d --build
  args:
    chdir: /opt/ugc
  tags: [docker]

# =====================
# Laravel permissions
# =====================
- name: Fix permission for ugc-api
  become: true
  command: >
    docker compose exec -T ugc-api
    chown -R www-data:www-data storage bootstrap/cache
  args:
    chdir: /opt/ugc
  tags: [ugc-api]

- name: Fix permission for ugc-admin-api
  become: true
  command: >
    docker compose exec -T ugc-admin-api
    chown -R www-data:www-data storage bootstrap/cache
  args:
    chdir: /opt/ugc
  tags: [ugc-admin-api]

# =====================
# Composer
# =====================
- name: Install composer dependencies for ugc-api
  become: true
  command: >
    docker compose exec -T ugc-api
    composer install --no-interaction --optimize-autoloader
  args:
    chdir: /opt/ugc
  tags: [ugc-api]

- name: Install composer dependencies for ugc-admin-api
  become: true
  command: >
    docker compose exec -T ugc-admin-api
    composer install --no-interaction --optimize-autoloader
  args:
    chdir: /opt/ugc
  tags: [ugc-admin-api]

# =====================
# Migrations (opt-in)
# =====================
- name: Run migrate for ugc-api
  become: true
  command: >
    docker compose exec -T ugc-api
    php artisan migrate --force
  args:
    chdir: /opt/ugc
  tags: [ugc-api, migrate]

- name: Run migrate for ugc-admin-api
  become: true
  command: >
    docker compose exec -T ugc-admin-api
    php artisan larke-admin:import-route
  args:
    chdir: /opt/ugc
  tags: [ugc-admin-api, migrate]
