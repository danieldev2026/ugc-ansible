- name: Ensure /opt/ugc directory exists
  file:
    path: /opt/ugc
    state: directory
    owner: ducle
    group: ducle
    mode: '0755'

- name: Ensure base directories
  file:
    path: "/opt/ugc/{{ item }}"
    state: directory
    owner: ducle
    group: ducle
    mode: '0755'
  loop:
    - env
    - volumes
    - nginx
    - nginx/conf.d

- name: Copy nginx config
  copy:
    src: nginx/nginx.conf
    dest: /opt/ugc/nginx/nginx.conf
    owner: ducle
    group: ducle
    mode: '0644'

- name: Copy nginx sites config
  copy:
    src: nginx/conf.d/sites.conf
    dest: /opt/ugc/nginx/conf.d/sites.conf
    owner: ducle
    group: ducle
    mode: '0644'

- name: Copy docker-compose.yml (registry version)
  copy:
    src: docker-compose.registry.yml
    dest: /opt/ugc/docker-compose.yml
    owner: ducle
    group: ducle
    mode: '0644'

- name: Copy env files
  copy:
    src: "env/{{ item }}"
    dest: "/opt/ugc/env/{{ item }}"
    owner: ducle
    group: ducle
    mode: '0644'
  loop:
    - api.env
    - admin-api.env
    - admin.env
    - ui.env

- name: Clone ugc-api
  become: false
  git:
    repo: git@github.com:danieldev2026/ugc-api.git
    dest: /opt/ugc/ugc-api
    version: "{{ branch | default('develop') }}"
    force: yes

- name: Clone ugc-admin-api
  become: false
  git:
    repo: git@github.com:danieldev2026/ugc-admin-api.git
    dest: /opt/ugc/ugc-admin-api
    version: "{{ branch | default('develop') }}"
    force: yes

- name: Copy api env to ugc-api
  copy:
    src: env/api.env
    dest: /opt/ugc/ugc-api/.env
    owner: ducle
    group: ducle
    mode: '0644'

- name: Copy admin api env to ugc-admin-api
  copy:
    src: env/admin-api.env
    dest: /opt/ugc/ugc-admin-api/.env
    owner: ducle
    group: ducle
    mode: '0644'

- name: Create .env file for docker-compose
  copy:
    content: |
      REGISTRY={{ registry | default('docker.io') }}
      REGISTRY_USER={{ registry_user | default('ugc') }}
      TAG={{ tag | default('latest') }}
      MYSQL_ROOT_PASSWORD={{ mysql_root_password | default('ugcDEV@2026') }}
    dest: /opt/ugc/.env
    owner: ducle
    group: ducle
    mode: '0644'

- name: Docker login to registry
  become: true
  command: docker login {{ registry | default('docker.io') }} -u {{ registry_user }} -p {{ registry_password }}
  when: registry_password is defined
  no_log: true

- name: Pull latest images
  become: true
  command: docker compose pull
  args:
    chdir: /opt/ugc

- name: Docker compose up
  become: true
  command: docker compose up -d
  args:
    chdir: /opt/ugc

- name: Fix permission for ugc-api
  become: true
  command: >
    docker compose exec -T ugc-api
    chown -R www-data:www-data storage bootstrap/cache
  args:
    chdir: /opt/ugc

- name: Fix permission for ugc-admin-api
  become: true
  command: >
    docker compose exec -T ugc-admin-api
    chown -R www-data:www-data storage bootstrap/cache
  args:
    chdir: /opt/ugc

- name: Run migrate for ugc-api
  become: true
  command: >
    docker compose exec -T ugc-api
    php artisan migrate --force
  args:
    chdir: /opt/ugc

- name: Run migrate for ugc-admin-api
  become: true
  command: >
    docker compose exec -T ugc-admin-api
    php artisan larke-admin:import-route
  args:
    chdir: /opt/ugc
